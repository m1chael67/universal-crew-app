
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>All Jobs - Universal Rentals</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="container">
    <h1>All Jobs</h1>
    <div id="job-list">
      <p>Loading jobs...</p>
    </div>
  </div>
  <script>
    async function fetchCSVData() {
      try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSiCVJqaIrsBdGSXhdJG-yPooQUbGzfiRXfdhTXmYna6hcgzGf5jaJXX61Ok6IsM6VCQNhLDN_odNZF/pub?output=csv');
        const csvText = await response.text();
        return csvText.trim().split('\n').map(row => row.split(','));
      } catch (error) {
        console.error('Error loading jobs:', error);
        document.getElementById('job-list').innerHTML = '<p style="color:red;">Error loading jobs. Sheet may not be public.</p>';
        return [];
      }
    }

    function formatDate(dateStr) {
      if (dateStr.includes("Date(")) {
        const [_, y, m, d] = dateStr.match(/Date\((\d+),(\d+),(\d+)\)/);
        return `${+m + 1}/${+d}/${y}`;
      }
      return dateStr;
    }

    async function renderJobs() {
      const data = await fetchCSVData();
      const headers = data[0];
      const rows = data.slice(1);

      const today = new Date();
      const todayStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;

      const jobMap = {};

      for (const row of rows) {
        const [Name, Address, Phone, DateStr, Item, Quantity, Type, Note] = row;
        const dateKey = formatDate(DateStr);

        if (dateKey !== todayStr) continue;

        const key = Name + dateKey;
        if (!jobMap[key]) {
          jobMap[key] = {
            Name,
            Address,
            Phone,
            Date: dateKey,
            Type,
            inventory: []
          };
        }

        jobMap[key].inventory.push({ item: Item, quantity: Quantity, note: Note });
      }

      const jobList = document.getElementById("job-list");
      jobList.innerHTML = '';

      if (Object.keys(jobMap).length === 0) {
        jobList.innerHTML = '<p>No jobs for today.</p>';
        return;
      }

      for (const job of Object.values(jobMap)) {
        const card = document.createElement("div");
        card.className = "job-card";

        const header = document.createElement("div");
        header.className = "job-header";
        header.innerHTML = `<strong>${job.Name}</strong><span class="job-date">${job.Date}</span>`;

        const details = document.createElement("div");
        details.innerHTML = `
          <p><strong>Type:</strong> ${job.Type}</p>
          <p><strong>Address:</strong> ${job.Address}</p>
          <p><strong>Phone:</strong> ${job.Phone}</p>
          <ul></ul>
        `;

        const ul = details.querySelector("ul");

        job.inventory.forEach(i => {
          const li = document.createElement("li");
          li.style.display = "flex";
          li.style.justifyContent = "space-between";
          li.style.alignItems = "center";

          const itemText = document.createElement("span");
          itemText.textContent = i.item;

          const qtyNote = document.createElement("span");

          const qtySpan = document.createElement("span");
          qtySpan.textContent = `Ã— ${i.quantity}`;
          qtySpan.style.color = "green";
          qtySpan.style.marginRight = "12px";

          qtyNote.appendChild(qtySpan);

          if (i.note) {
            const noteSpan = document.createElement("span");
            noteSpan.textContent = i.note;
            noteSpan.style.color = "red";
            noteSpan.style.fontStyle = "italic";
            qtyNote.appendChild(noteSpan);
          }

          li.appendChild(itemText);
          li.appendChild(qtyNote);
          ul.appendChild(li);
        });

        card.appendChild(header);
        card.appendChild(details);
        jobList.appendChild(card);
      }
    }

    window.onload = renderJobs;
  </script>
</body>
</html>
